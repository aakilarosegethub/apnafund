@php
    $activeTheme = 'themes.apnafund.';
    $activeThemeTrue = 'themes.apnafund.';
@endphp
@extends($activeTheme . 'layouts.dashboard')
@section('style')
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet" />

  <style>
    :root { --radius: 24px; --border:#e6e6e6; }
    .editor-shell{
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
      background: #fff;
      position: relative;
    }
    /* Editor */
    #editor{
      background:#fff;
      height: 400px;
      min-height: 400px;
    }
    .ql-container.ql-snow{
      border:none;
      font-size: 16px;
    }
    .ql-editor{
      font-size:22px;
      color:#404040;
      min-height: 350px;
      padding: 20px;
    }
    .ql-editor p {
      margin-bottom: 1em;
    }
    .ql-editor.ql-blank::before{
      color:#9aa0a6; /* placeholder color */
      left:32px; right:32px;
    }
    /* Toolbar placed at the bottom */
    .ql-toolbar{
      border-top:1px solid var(--border) !important;
      border-bottom:none !important;
      border-left:none !important;
      border-right:none !important;
      padding:10px 16px !important;
      display:flex !important;
      gap:8px;
      justify-content:flex-start;
      background:#fff !important;
      min-height: 50px;
    }
    .ql-snow .ql-picker, .ql-snow .ql-stroke{color:#111;stroke:#111}
    .ql-snow .ql-fill{fill:#111}
    .ql-snow .ql-active .ql-stroke{stroke:#0f8e6f}
    .ql-snow .ql-active .ql-fill{fill:#0f8e6f}
    /* Make buttons a bit larger, like the screenshot */
    .ql-toolbar button{
      width:36px;height:36px;border-radius:10px;
      border: 1px solid #ddd;
      background: #fff;
    }
    .ql-toolbar button:hover {
      background: #f5f5f5;
    }
    .ql-toolbar .ql-picker {
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
    }
    .hidden-input{ display:none; }
    
    /* Ensure Quill editor is visible */
    .ql-container {
      display: block !important;
      visibility: visible !important;
    }
    .ql-editor {
      display: block !important;
      visibility: visible !important;
    }
    .ql-toolbar {
      display: flex !important;
      visibility: visible !important;
    }
    
    /* YouTube iframe styling in editor */
    .ql-editor iframe {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* Responsive iframe */
    .ql-editor iframe[src*="youtube.com/embed/"] {
      width: 100%;
      height: 315px;
      max-width: 560px;
    }
    
    @media (max-width: 768px) {
      .ql-editor iframe[src*="youtube.com/embed/"] {
        height: 200px;
      }
    }
  </style>
@endsection
@section('frontend')

                <div class="tab-pane fade active show" id="create" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="content-card">
                                <h4 class="mb-4">Create New Campaign</h4> 
                                
                                <form action="{{ route('user.campaign.store') }}" method="POST" id="createCampignForm" enctype="multipart/form-data">
                                    @csrf
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="form-group">
                                                <label for="CampignTitle" class="form-label">Campign Title *</label>
                                                <input type="text" class="form-control" id="CampignTitle" name="name" placeholder="Enter a compelling title for your Campign" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="CampignCategory" class="form-label">Category *</label>
                                                <select class="form--control form-select" name="category_id" id="CampignCategory" required>
                                                    <option value="" selected>@lang('Select Category')</option>
                                                    @foreach ($categories as $category)
                                                        <option value="{{ $category->id }}" @selected(old('category_id') == $category->id)>
                                                            {{ __(@$category->name) }}
                                                        </option>
                                                    @endforeach
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="CampignDescription" class="form-label">Description *</label>
                                        <div class="editor-shell">
      <!-- The editor -->
      <div id="editor" placeholder="Hi, my name is Jane and I'm fundraising forâ€¦"></div>

      <!-- Toolbar at the bottom -->
      <div id="toolbar">
        <span class="ql-formats">
          <select class="ql-header">
            <option value="1">Heading 1</option>
            <option value="2">Heading 2</option>
            <option value="3">Heading 3</option>
            <option value="4">Heading 4</option>
            <option value="5">Heading 5</option>
            <option value="6">Heading 6</option>
            <option selected>Normal</option>
          </select>
        </span>
        <span class="ql-formats">
          <button class="ql-bold"></button>
          <button class="ql-italic"></button>
          <button class="ql-underline"></button>
          <button class="ql-strike"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-list" value="ordered"></button>
          <button class="ql-list" value="bullet"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-link"></button>
          <button class="ql-image"></button>
          <button class="ql-video"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-clean"></button>
        </span>
      </div>
    </div>
                                        <textarea id="CampignDescription" name="description" style="display: none;" required></textarea>
                                    </div>

                                    <!-- Main Campaign Image -->
                                    <div class="form-group">
                                        <label for="mainImage" class="form-label">Main Campaign Image *</label>
                                        <input type="file" class="form-control" id="mainImage" name="image" accept="image/*" required>
                                        <small class="text-muted">This will be the primary image displayed for your campaign</small>
                                    </div>

                                    <!-- YouTube Video URL -->
                                    <div class="form-group mb-4">
                                        <label class="form-label">Campaign Video (YouTube URL)</label>
                                        
                                        <!-- YouTube URL Section -->
                                        <div id="youtube_url_section_new">
                                            <input type="url" class="form-control mb-2" name="youtube_url" id="youtube_url_new" placeholder="https://www.youtube.com/watch?v=dQw4w9WgXcQ">
                                            <small class="text-muted">Enter YouTube video URL for better streaming performance - Optional</small>
                                            <div class="mt-2">
                                                <div class="youtube-preview-new"></div>
                                                <div id="youtube-validation-message" class="text-danger mt-1" style="display: none;"></div>
                                            </div>
                                        </div>
                                    </div>

                                    {{-- 
                                    <!-- Video Upload Options - COMMENTED OUT -->
                                    <div class="form-group mb-4">
                                        <label class="form-label">Campaign Video</label>
                                        
                                        <!-- Video Upload Toggle -->
                                        <div class="mb-3">
                                            <div class="btn-group" role="group" aria-label="Video upload options">
                                                <input type="radio" class="btn-check" name="video_type" id="video_file_new" value="file" autocomplete="off" checked>
                                                <label class="btn btn-outline-primary" for="video_file_new">Upload Video File</label>
                                                
                                                <input type="radio" class="btn-check" name="video_type" id="video_youtube_new" value="youtube" autocomplete="off">
                                                <label class="btn btn-outline-primary" for="video_youtube_new">YouTube URL</label>
                                            </div>
                                        </div>
                                        
                                        <!-- File Upload Section -->
                                        <div id="file_upload_section_new" style="display: block;">
                                            <input type="file" class="form-control mb-2" name="video" accept="video/*">
                                            <small class="text-muted">Upload a video file (MP4, AVI, MOV, etc.) - Optional</small>
                                            
                                            <!-- Auto Upload to YouTube Option -->
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" name="auto_upload_youtube" id="auto_upload_youtube_new" value="1">
                                                <label class="form-check-label" for="auto_upload_youtube_new">
                                                    <strong>ðŸš€ Auto-upload to YouTube</strong> (Better streaming performance)
                                                </label>
                                                <small class="text-muted d-block">Video will be automatically uploaded to YouTube and streamed from there</small>
                                            </div>
                                        </div>
                                    </div>
                                    --}}

                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label for="targetAmount" class="form-label">Target Amount ({{ $setting->cur_sym }}) *</label>
                                                <input type="number" name="goal_amount" class="form-control" id="targetAmount" placeholder="5000" min="1" step="0.01" required>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label for="startDate" class="form-label">Start Date *</label>
                                                <input type="date" name="start_date" class="form-control" id="startDate" required>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label for="endDate" class="form-label">End Date *</label>
                                                <input type="date" name="end_date" class="form-control" id="endDate" required>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Gallery Images Section - COMMENTED OUT -->
                                    {{-- 
                                    <div class="form-group gallery-section">
                                        <label class="form-label">Gallery Images *</label>
                                        
                                        <!-- Simple Multiple File Input (Primary) -->
                                        <div id="simpleFileInput">
                                            <input type="file" class="form-control" name="gallery_images[]" id="galleryImages" accept="image/*" multiple required>
                                            <small class="text-muted">Select multiple images for your campaign gallery (JPG, JPEG, PNG - Max 5MB each)</small>
                                        </div>
                                        
                                        <!-- Dropzone (Fallback) -->
                                        <div class="dropzone" id="" style="display: none;">
                                            <div class="dz-message">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                                <h4>Drop images here or click to upload</h4>
                                                <p>Upload multiple images for your campaign gallery</p>
                                                <small>Supported: JPG, JPEG, PNG (Max: 5MB each)</small>
                                            </div>
                                        </div>
                                        
                                        <!-- Fallback file input in case Dropzone fails -->
                                        <div id="fallbackFileInput" style="display: none;">
                                            <input type="file" class="form-control" name="gallery_images[]" accept="image/*" multiple>
                                            <small class="text-muted">Select multiple images for your campaign gallery</small>
                                        </div>
                                        <small class="text-muted">* Minimum one gallery image is required</small>
                                    </div>
                                    --}}

                                    <div class="d-flex gap-3">
                                        <button type="button" class="btn btn-primary" id="submitBtn" onclick="showEditorContent()">
                                            <i class="fas fa-save me-2"></i>Submit 
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="previewCampign()">
                                            <i class="fas fa-eye me-2"></i>Preview
                                        </button>
                                        <button type="button" class="btn btn-secondary">
                                            <i class="fas fa-times me-2"></i>Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                                                            <div class="col-lg-4">
                            <div class="content-card">
                                <h5 class="mb-3">Preview</h5>
                                <div id="CampignPreview">
                                    <div class="preview-card">
                                        <div class="preview-image" id="previewMainImage">
                                            <i class="fas fa-image" id="previewImageIcon"></i>
                                            <img id="previewImage" src="" alt="Preview" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 10px 10px 0 0;">
                                        </div>
                                        <div class="preview-content">
                                            <div class="preview-title">Your Campign Title</div>
                                            <div class="preview-description">Your Campign description will appear here...</div>
                                            <div class="preview-meta">
                                                <span class="preview-category">Category</span>
                                                <span class="preview-amount">$0</span>
                                            </div>
                                            <div class="preview-progress">
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: 0%"></div>
                                                </div>
                                                <small class="text-muted">0% of $0 goal</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
@endsection

@include($activeTheme . 'user.campaign.commonStyleScript')

@push('page-style-lib')
    <link rel="stylesheet" href="{{ asset('assets/universal/css/datepicker.css') }}">
    <!-- Quill.js CSS -->
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet" />
@endpush

@push('page-script-lib')
<script src="{{ asset('assets/universal/js/datepicker.js') }}"></script>
<script src="{{ asset('assets/universal/js/datepicker.en.js') }}"></script>
    <!-- Quill.js JS -->
    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.js"></script>
@endpush




@section('page-script')
    <!-- Hidden file input for custom image handler -->
  <input type="file" id="imageInput" accept="image/*" class="hidden-input" />

    <script>
  // Define handlers before initializing Quill
  function customImageHandler() {
    const input = document.getElementById('imageInput');
    input.click();

    input.onchange = function() {
      const file = input.files[0];
      if (!file) return;
      
      console.log('File selected:', file.name, file.size);
      
      // Validate file type
      if (!file.type.match('image.*')) {
        alert('Please select an image file');
        return;
      }
      
      // Validate file size (5MB max)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image size must be less than 5MB');
        return;
      }
      
      // Create FormData for file upload
      const formData = new FormData();
      formData.append('files', file);
      formData.append('_token', document.querySelector('meta[name="csrf-token"]').getAttribute('content'));

      console.log('Uploading file...');
      
      // Upload file to server using XMLHttpRequest
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '{{ route("user.campaign.upload-image") }}');
      
      xhr.onload = function() {
        console.log('Upload response:', xhr.status, xhr.responseText);
        if (xhr.status === 200) {
          try {
            const response = JSON.parse(xhr.responseText);
            console.log('Parsed response:', response);
            if (response.location) {
              console.log('Inserting image:', response.location);
              // Insert the uploaded image at current cursor position
              const range = quill.getSelection();
              if (range) {
                quill.insertEmbed(range.index, 'image', response.location);
                quill.setSelection(range.index + 1, 0);
              } else {
                // If no selection, insert at the end
                const length = quill.getLength();
                quill.insertEmbed(length - 1, 'image', response.location);
                quill.setSelection(length, 0);
              }
              console.log('Image inserted successfully');
            } else {
              alert('Upload failed: ' + (response.message || 'Invalid response'));
            }
          } catch (e) {
            console.error('JSON parse error:', e);
            alert('Upload failed: Invalid JSON response');
          }
        } else {
          alert('Upload failed: Server error ' + xhr.status);
        }
      };
      
      xhr.onerror = function() {
        console.error('Upload error');
        alert('Upload failed: Network error');
      };
      
      xhr.send(formData);
    };
  }

  function customVideoHandler() {
    const url = prompt('Paste video URL (YouTube, Vimeo, MP4, etc.)');
    if (!url) return;
    
    // Convert YouTube URL to embeddable format
    let embedUrl = url;
    if (url.includes('youtube.com/watch?v=')) {
      const videoId = url.split('v=')[1].split('&')[0];
      embedUrl = `https://www.youtube.com/embed/${videoId}`;
    } else if (url.includes('youtu.be/')) {
      const videoId = url.split('youtu.be/')[1].split('?')[0];
      embedUrl = `https://www.youtube.com/embed/${videoId}`;
    }
    
    const range = quill.getSelection(true);
    if (range) {
      // Create iframe element for YouTube videos
      if (embedUrl.includes('youtube.com/embed/')) {
        const iframe = document.createElement('iframe');
        iframe.src = embedUrl;
        iframe.width = '560';
        iframe.height = '315';
        iframe.frameBorder = '0';
        iframe.allowFullscreen = true;
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        iframe.style.margin = '10px 0';
        
        // Insert the iframe
        quill.clipboard.dangerouslyPasteHTML(range.index, iframe.outerHTML);
        quill.setSelection(range.index + 1, 0);
      } else {
        // For other video URLs, use the standard video embed
        quill.insertEmbed(range.index, 'video', url, 'user');
        quill.setSelection(range.index + 1, 0);
      }
    }
  }

  // Wait for DOM to be ready before initializing Quill
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing Quill editor...');
    
    // Init Quill with custom toolbar container (placed after the editor)
    const quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: "Hi, my name is Jane and I'm fundraising forâ€¦",
    modules: {
      toolbar: {
        container: '#toolbar',
        handlers: {
          image: customImageHandler,
          video: customVideoHandler
        }
      }
    }
  });
  
  console.log('Quill editor initialized:', quill);
  console.log('Quill root element:', quill.root);
  
  // Make quill globally available
  window.quill = quill;
  
  }); // End DOMContentLoaded

  // Function to set editor content in cookie and submit form
  function showEditorContent() {
    console.log('showEditorContent called');
    
    if (window.quill) {
      // Test: Add some content if editor is empty
      const currentContent = window.quill.getText();
      if (!currentContent || currentContent.trim() === '') {
        console.log('Editor is empty, adding test content');
        window.quill.insertText(0, 'Test content from JavaScript');
      }
      // Get content using multiple methods to ensure we capture it
      const editorContent = window.quill.root.innerHTML;
      const textContent = window.quill.getText();
      const deltaContent = JSON.stringify(window.quill.getContents());
      
      console.log('Raw HTML Content:', editorContent);
      console.log('Text Content:', textContent);
      console.log('Delta Content:', deltaContent);
       // Content is already in the hidden textarea, no need to append
      
      // Check if content is meaningful (not just empty tags)
      const hasContent = editorContent && 
                        editorContent.trim() !== '<p><br></p>' && 
                        editorContent.trim() !== '<p></p>' &&
                        textContent.trim() !== '';
      
      // Always set cookies for debugging, regardless of content
      // Content will be submitted directly via form
      
      console.log('Editor content set in cookies (always)');
      console.log('HTML Content:', editorContent);
      console.log('Text Content:', textContent);
      console.log('Has Content Check:', hasContent);
      
      if (hasContent) {
        
        // Also copy content to hidden textarea
        const textarea = document.getElementById('CampignDescription');
        if (textarea) {
          textarea.value = editorContent;
          console.log('Content also copied to textarea');
        }
        
         // Submit the campaign form by its ID
         const form = document.getElementById('createCampignForm');
        if (form) {
          console.log('Submitting campaign form by ID...');
          form.submit();
        }
      } else {
        alert('Please add some content to the description field before submitting!');
        console.log('No meaningful content found in editor');
      }
    } else {
      alert('Quill editor not found!');
    }
  }

  // YouTube URL Validation
  function validateYouTubeUrl(url) {
    if (!url || url.trim() === '') {
      return { valid: true, message: '' }; // Empty is allowed (optional field)
    }
    
    const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/(watch\?v=|embed\/|v\/)|youtu\.be\/)[\w\-]+/i;
    
    if (!youtubeRegex.test(url)) {
      return { 
        valid: false, 
        message: 'Please enter a valid YouTube URL (e.g., https://www.youtube.com/watch?v=VIDEO_ID or https://youtu.be/VIDEO_ID)' 
      };
    }
    
    return { valid: true, message: '' };
  }

  // Handle YouTube URL validation
  function handleYouTubeValidation() {
    const youtubeInput = document.getElementById('youtube_url_new');
    const validationMessage = document.getElementById('youtube-validation-message');
    
    if (youtubeInput && validationMessage) {
      youtubeInput.addEventListener('blur', function() {
        const url = this.value.trim();
        const validation = validateYouTubeUrl(url);
        
        if (!validation.valid) {
          validationMessage.textContent = validation.message;
          validationMessage.style.display = 'block';
          this.classList.add('is-invalid');
        } else {
          validationMessage.style.display = 'none';
          this.classList.remove('is-invalid');
        }
      });
      
      youtubeInput.addEventListener('input', function() {
        if (this.classList.contains('is-invalid')) {
          const url = this.value.trim();
          const validation = validateYouTubeUrl(url);
          
          if (validation.valid) {
            validationMessage.style.display = 'none';
            this.classList.remove('is-invalid');
          }
        }
      });
    }
  }

  // Handle form submission - copy Quill content to hidden textarea
        document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up form submission handler');
    
    // Initialize YouTube URL validation
    try {
      handleYouTubeValidation();
    } catch (e) {
      console.log('YouTube validation not available:', e);
    }
    
    const form = document.getElementById('createCampignForm');
    const textarea = document.getElementById('CampignDescription');
    
    console.log('Form found:', !!form);
    console.log('Textarea found:', !!textarea);
    console.log('Quill instance:', !!quill);
    
    if (form) {
      form.addEventListener('submit', function(e) {
        console.log('Form submit event triggered');
        
        // First, copy Quill content to textarea
        if (quill) {
          const editorContent = quill.root.innerHTML;
          console.log('Editor content:', editorContent);
          
          if (textarea) {
            textarea.value = editorContent;
            console.log('Textarea value set to:', textarea.value);
          } else {
            console.error('Textarea not found!');
          }
        } else {
          console.error('Quill instance not found!');
        }
        
        // Ensure the textarea is not empty to pass validation
        if (textarea && !textarea.value.trim()) {
          textarea.value = '<p></p>';
        }
        
        // Then check if all required fields are filled
        const requiredFields = form.querySelectorAll('[required]');
        let allFieldsValid = true;
        
        requiredFields.forEach(function(field) {
          if (!field.value.trim()) {
            console.error('Required field is empty:', field.name || field.id);
            allFieldsValid = false;
            field.style.borderColor = 'red';
          } else {
            field.style.borderColor = '';
          }
        });
        
        if (!allFieldsValid) {
          e.preventDefault();
          alert('Please fill in all required fields');
          return false;
        }
      });
    } else {
      console.error('Form not found!');
            }
        });
    </script>

<style>
  /* TinyMCE Editor Styling */
  .tox-tinymce {
    height: 800px !important;
  }
  
  .tox-edit-area__iframe {
    height: 750px !important;
  }
  
  .tox-editor-container {
    height: 800px !important;
  }
  
  /* Move image button to right corner */
  .jodit-toolbar__box .jodit-toolbar-editor-collection {
    display: flex;
  }
  .jodit-toolbar__box .jodit-toolbar-editor-collection 
  .jodit-toolbar-button[data-ref="image"] {
    margin-left: auto !important;  /* push image to far right */
  }
</style>


@endsection